<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aurelia - Job Detail</title>

    <style>
        /* 全体設定 */
        body {
            margin: 0;
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            color: #333;
            background: #f4f6f8;
            overflow-x: hidden;
            position: relative;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        /* コンテナ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* ヘッダー */
        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .nav-links a {
            margin-left: 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #333;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #2563eb;
        }

        /* ヒーローセクション */
        .hero-detail {
            background: linear-gradient(120deg, #2563eb, #5f99f7);
            color: #fff;
            padding: 3rem 1rem;
            text-align: center;
        }

        .hero-detail p {
            font-size: 1.1rem;
            margin-bottom: 0;
            opacity: 0.85;
        }

        /* 詳細セクション */
        .detail-section {
            padding: 2rem 1rem;
            background: #fff;
        }

        /* 詳細カード */
        .job-detail-card {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 650px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.6s ease;
        }

        .job-detail-card.show {
            opacity: 1;
            transform: translateY(0);
        }

        .job-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: capitalize;
            text-align: center;
        }

        .job-tag {
            display: inline-block;
            background: #eef2f7;
            color: #555;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }

        .job-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #555;
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .job-text ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }

        .job-income {
            font-size: 1rem;
            font-weight: 500;
            margin-top: 1rem;
            color: #2563eb;
        }

        /* footer */
        footer {
            border-top: 1px solid #eee;
            padding: 2rem 1rem;
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            background: #fff;
            margin-top: 4rem;
        }

        .btn-apply {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            background-color: #2563eb;
            color: #fff;
            border-radius: 0.25rem;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background-color 0.3s;
            text-align: center;
        }

        .btn-apply:hover {
            background-color: #174bbd;
        }

        .btn-back {
            display: inline-block;
            margin-top: 2rem;
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: #fff;
            border-radius: 0.25rem;
            transition: background-color 0.3s;
        }

        .btn-back:hover {
            background-color: #174bbd;
        }

        /* ローディングスピナー */
        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ガウス分布グラフ */
        .gauss-chart-container {
            margin-top: 2rem;
            width: 100%;
            height: 200px;
            position: relative;
        }

        svg#gaussChart {
            background: #fafafa;
            border-radius: 8px;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .dist-area {
            fill: rgba(37, 99, 235, 0.2);
            /* 全体塗り(薄い青) */
        }

        .highlight-area {
            fill: rgba(37, 99, 235, 0.4);
            /* ±10%塗り(少し濃い青) */
        }

        .chart-hover-line {
            stroke: #2563eb;
            stroke-width: 1;
            stroke-dasharray: 3, 2;
            display: none;
        }

        .chart-hover-circle {
            fill: #2563eb;
            r: 4;
            display: none;
        }

        .tooltip {
            position: absolute;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-size: 0.8rem;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body>
    <!-- ヘッダー -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="text-xl font-bold">Aurelia</a>
                <nav class="nav-links">
                    <a href="/">Home</a>
                    <a href="/jobs">Jobs</a>
                    <a href="/about">About</a>
                    <a href="/contact">Contact</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- グラデーションエリア(タイトル非表示) -->
    <div class="hero-detail">
        <p>Opportunity awaits</p>
    </div>

    <section class="detail-section">
        <div class="container">
            <!-- カード -->
            <div id="job-detail-container" class="job-detail-card" style="text-align:center;">
                <!-- 初期はスピナー -->
                <div class="spinner"></div>
            </div>

            <!-- 戻るボタン -->
            <div style="text-align: center;">
                <a href="/jobs" class="btn-back">← Back to Jobs</a>
            </div>
        </div>
    </section>

    <footer>
        © 2024 Aurelia. All Rights Reserved.
    </footer>

    <div class="tooltip" id="chartTooltip"></div>

    <script>
        // ------ 1. 正規分布 (ガウス) のPDFを求める関数 ------
        function gaussianPDF(x, mu, sigma) {
            // pdf(x) = (1/(sigma*sqrt(2π))) * e^(-0.5*((x-mu)/sigma)^2)
            const coeff = 1 / (sigma * Math.sqrt(2 * Math.PI));
            const exponent = -0.5 * ((x - mu) / sigma) ** 2;
            return coeff * Math.exp(exponent);
        }

        // ------ 2. グラフ描画 ------
        function drawGaussChart(svgId, mu, sigma, highlightMin, highlightMax) {
            const svg = document.getElementById(svgId);
            const width = svg.clientWidth;    // SVGの表示サイズ(px)
            const height = svg.clientHeight;

            // x軸: [mu-3σ, mu+3σ]
            const xMin = mu - 3 * sigma;
            const xMax = mu + 3 * sigma;

            // y軸: pdf の最大は x=mu -> pdf(mu) = 1/(σ√(2π))
            const maxPDF = gaussianPDF(mu, mu, sigma);

            // 分布をプロットする点を作る (サンプリング数 = 60)
            const numPoints = 60;
            const step = (xMax - xMin) / (numPoints - 1);
            let points = [];
            for (let i = 0; i < numPoints; i++) {
                const xVal = xMin + i * step;
                const pdfVal = gaussianPDF(xVal, mu, sigma);
                // スケール変換
                const xPix = ((xVal - xMin) / (xMax - xMin)) * width;
                const yPix = height - (pdfVal / maxPDF) * (height - 10);
                points.push({ x: xPix, y: yPix, realX: xVal });
            }

            // -------------- 全体領域パス --------------
            let pathD = `M ${points[0].x},${height}`;
            for (const pt of points) {
                pathD += ` L ${pt.x},${pt.y}`;
            }
            pathD += ` L ${points[points.length - 1].x},${height} Z`;

            // <path> 要素生成
            const areaPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            areaPath.setAttribute("class", "dist-area");
            areaPath.setAttribute("d", pathD);
            svg.appendChild(areaPath);

            // -------------- ハイライト領域 --------------
            const clipPoints = points.filter(pt => {
                // 実際の xVal が [highlightMin, highlightMax] 内かどうか
                const xVal = pt.realX;
                return (xVal >= highlightMin) && (xVal <= highlightMax);
            });
            if (clipPoints.length >= 2) {
                // クリップ領域の両端を補完
                const leftXVal = highlightMin;
                const leftPdf = gaussianPDF(leftXVal, mu, sigma);
                const leftXPix = ((leftXVal - xMin) / (xMax - xMin)) * width;
                const leftYPix = height - (leftPdf / maxPDF) * (height - 10);

                const rightXVal = highlightMax;
                const rightPdf = gaussianPDF(rightXVal, mu, sigma);
                const rightXPix = ((rightXVal - xMin) / (xMax - xMin)) * width;
                const rightYPix = height - (rightPdf / maxPDF) * (height - 10);

                // path生成
                let highlightPathD = `M ${leftXPix},${height} L ${leftXPix},${leftYPix}`;
                for (const pt of clipPoints) {
                    highlightPathD += ` L ${pt.x},${pt.y}`;
                }
                highlightPathD += ` L ${rightXPix},${rightYPix} L ${rightXPix},${height} Z`;

                const highlightPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                highlightPath.setAttribute("class", "highlight-area");
                highlightPath.setAttribute("d", highlightPathD);
                svg.appendChild(highlightPath);
            }

            // -------------- マウスホバーでのインタラクション --------------
            // 横線 or 垂直線を引いたり、円を表示
            const hoverLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            hoverLine.setAttribute("class", "chart-hover-line");
            hoverLine.setAttribute("id", "hoverLine");
            svg.appendChild(hoverLine);

            const hoverCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            hoverCircle.setAttribute("class", "chart-hover-circle");
            hoverCircle.setAttribute("id", "hoverCircle");
            hoverCircle.setAttribute("r", 4);
            svg.appendChild(hoverCircle);

            const tooltip = document.getElementById("chartTooltip");

            svg.addEventListener("mousemove", (e) => {
                const rect = svg.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;

                // x軸を逆スケーリングして realX を求める
                const realX = xMin + (mouseX / width) * (xMax - xMin);
                const pdfVal = gaussianPDF(realX, mu, sigma);
                const yPix = height - (pdfVal / maxPDF) * (height - 10);

                // 表示更新
                hoverLine.setAttribute("x1", mouseX);
                hoverLine.setAttribute("x2", mouseX);
                hoverLine.setAttribute("y1", height);
                hoverLine.setAttribute("y2", yPix);
                hoverLine.style.display = "block";

                hoverCircle.setAttribute("cx", mouseX);
                hoverCircle.setAttribute("cy", yPix);
                hoverCircle.style.display = "block";

                // income と確率を適当にフォーマット
                const incomeVal = Math.round(realX);
                const probVal = pdfVal.toPrecision(2);

                tooltip.style.left = (e.pageX + 10) + "px";
                tooltip.style.top = (e.pageY - 20) + "px";
                tooltip.innerHTML = `Income: ${incomeVal}<br>(pdf~${probVal})`;
                tooltip.style.opacity = "1";
            });

            svg.addEventListener("mouseleave", () => {
                hoverLine.style.display = "none";
                hoverCircle.style.display = "none";
                tooltip.style.opacity = "0";
            });
        }

        // ------ ロード時処理 ------
        document.addEventListener('DOMContentLoaded', async () => {
            const startTime = Date.now();
            const container = document.getElementById('job-detail-container');

            try {
                // URLクエリから jobID
                const params = new URLSearchParams(window.location.search);
                const jobID = params.get('id');
                if (!jobID) throw new Error('Job ID not found in query parameter.');

                // /api/jobs/detail?id=jobID で詳細JSON取得
                const response = await fetch(`/api/jobs/detail?id=${jobID}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch job detail. Status: ${response.status}`);
                }
                const jobData = await response.json();
                if (!jobData || !jobData.job_id) {
                    // 1秒はスピナー表示
                    const elapsed = Date.now() - startTime;
                    const remain = Math.max(0, 1000 - elapsed);
                    setTimeout(() => {
                        container.innerHTML = '<p style="color:red;">Job not found.</p>';
                    }, remain);
                    return;
                }

                // 要件を箇条書きに
                let requirementList = '';
                if (jobData.requirements) {
                    const splitted = jobData.requirements.split(',');
                    requirementList = splitted.map(req => `<li>${req.trim()}</li>`).join('');
                } else {
                    requirementList = '<li>Not specified</li>';
                }

                // 全体HTML
                const detailHTML = `
          <div class="job-title">${jobData.hiring_type || 'Untitled Job'}</div>
          <div class="job-tag">${jobData.job_tag || 'No Tag'}</div>
          
          <p class="job-text"><strong>Technology:</strong> ${jobData.technology_type || '-'}</p>
          
          <p class="job-text"><strong>Requirements:</strong><ul>${requirementList}</ul></p>
          
          <p class="job-text"><strong>Used Technology:</strong> ${jobData.used_technology || '-'}</p>
          
          <div class="job-income">
            <strong>Income Range:</strong> ${jobData.income_range} yen
          </div>

          <!-- ガウス分布グラフ -->
          <div class="gauss-chart-container">
            <svg id="gaussChart"></svg>
          </div>

          <a href="#" class="btn-apply">Apply Now</a>
        `;

                // スピナーを1秒見せてから表示
                const elapsed = Date.now() - startTime;
                const remain = Math.max(0, 1000 - elapsed);
                setTimeout(() => {
                    container.innerHTML = detailHTML;
                    container.classList.add('show');

                    // グラフ描画
                    // μ = jobData.income_range, σ= 500000(仮)
                    // ±10%をハイライト
                    const mu = Number(jobData.income_range) || 1000000;
                    const sigma = 500000;
                    const highlightMin = mu * 0.9;
                    const highlightMax = mu * 1.1;
                    drawGaussChart("gaussChart", mu, sigma, highlightMin, highlightMax);
                }, remain);

            } catch (err) {
                console.error(err);
                const elapsed = Date.now() - startTime;
                const remain = Math.max(0, 1000 - elapsed);
                setTimeout(() => {
                    container.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
                }, remain);
            }
        });
    </script>

</body>

</html>
